# HypoMeals
[![pipeline status](https://gitlab.oit.duke.edu/hypomeals/hypomeals/badges/master/pipeline.svg)](https://gitlab.oit.duke.edu/hypomeals/hypomeals/commits/master)

HypoMeals is a sophisticated food manufacturing management software. It features SKU and ingredients managment, product lines, and much more.

## Developer Guide

### Prerequisites

* [Docker Commmunity Edition](https://hub.docker.com/search/?type=edition&offering=community)
* [Docker Compose 1.8](https://docs.docker.com/compose/install/) or above. Depending on the host OS, this may or may not be bundled with Docker.
* [Python 3.7](https://www.python.org/) or above
* [Git](https://git-scm.com/)
* (Optional) [PyCharm Professional](https://www.jetbrains.com/pycharm/)

### Architecture

This project is built with [Django](https://www.djangoproject.com/), using the default ORM and template engine. If you haven't already, read the [official tutorials](https://docs.djangoproject.com/en/2.1/intro/) first.

The Django project is comprised on one "app": a Django term for a unit of executable code. The project itself lives under a subdirectory called `hypomeals`.

#### Models

Since we are using the Django ORM, the models are automatically managed by Django for us. There are several main models, as described below.

##### SKU

The `Sku` model represents, unsurprisingly, the SKUs. To conserve space, several fields are defined as `ForeingKey`s: the UPC numbers, and the Product Line. They can be retrieved / queried upon using the double underscore syntax provided by the Django ORM.

The `Sku` model also has a many-to-many relationship with `Ingredient`, through the `SkuIngredient` relation table. This relation is also known as "Formula".

Its primary key is `number`, corresponding to "SKU#", which can be autogenerated if one is not provided. 

The `__str__` and `__repr__` methods are overriden to reflect the standard display format for SKUs.

**Note: ** this model overrides the default `save()` method to supply a number if the user did not provide one. The number will be 1 plus the maximum number currently in the database.

##### Ingredient

The `Ingredient` model, similarly, represents the ingredients. The `vendor` field is defined as a `ForeignKey` for extensibility purposes: if in the future, a vendor has more attributes than just `info`, the cost of changing this model that would be much lower, than if `vendor` were a `CharField` in the model.

**Note:** similar to `Sku`, this model also overrides the default `save()` method to supply a number if a user did not provide one.

##### SkuIngredient

Also known as "Formula", this model is a multi-valued relation between `Sku` and `Ingredient` models.

##### ManufactureGoal / ManufactureDetail

These are auxiliary models to save and retrieve user's saved manufacturing goals.

#### Permission and Authentication

The project uses Django's built-in authentication system, with a custom user model (defined in `models.py` as `User`). Initially all users are added to the `Users` group, which only grants permission to view all objects (i.e., instances of models). An administrator (or a "superuser"), on the other hand, is allowed to add, change, delete, and view all objects.

Permission checking is done by the `@permission_required` decorator, or the `@auth.permission_required_ajax` decorator, if the view accepts AJAX requests.

Users without the required permission to access a particular resource will be redirected to the `403.html` page, where an error message is displayed. If the request was an AJAX one, a `JsonResponse` containing the error message is returned.

#### File Layout

The files are generally laid out according to Django's conventions: `models.py`, `urls.py`, etc., are all where they are supposed to be. However, for clarity's sake, there are a few changes to the standard Django directory layout, as described below:

##### Views

With dozens of webpages, a singular `views.py` quickly becomes too cluttered to browse. As a result, the views are moved into a Python package named `views`, separated in different Python source files named appropriately. The `views/__init__.py` then imports these separate views from their respective source files, and consolidates them under the root of the package, so that in `urls.py`, one can still write the familiar `views.<view_name>` syntax and everything still works as expected.

##### `bulk_export.py`

This file contains the general functions and data structures needed to generated CSV files from a given set of data.

##### `bulk_import.py` and `importers.py`

These two files work in tandem to parse, process, and import CSV formatted data supplied by user. The former defines the main driving logic, while the latter defines the detailed parsing logic.

Parsing of the CSV files are done by the standard library `csv` module. However, the generation of model instances and committance to database are highly automated, and heavily based on existing model structure.

##### `exceptions.py`

This file defines some custom exceptions that convey specific meanings. For example, a `DuplicateException` may be raised during the processing of one of the input files to both rollback all database changes and to contain enough information such that the user can fix the error.

##### `utils.py`

This file contains some helpful utility functions, decorators, and helper classes. For example, the `@parameterized` meta-decorator is defined in this file.

##### `auth.py`

This file defines some utility functions / decorators related to authentication and permission checking. For example, the `@permission_required_ajax` decorator is defined in this file.

#### Logs

We heavily configured the various loggers used by Django to maximize the information provided for debugging purposes. **The use of `print` statements are therefore discouraged**. Check out `hypomeals/HypoMeals/settings.py` to see how the logs are configured. 

### Code Style

Several languages are used throughout the project. To facilitate understandability, coding styles should be followed. **Reviewers should check whether a commit is properly formatted before approving!**

- Python: we use the [PEP 8](https://www.python.org/dev/peps/pep-0008/) style, with line width set to 88 characters.
- JavaScript: use of JavaScript should be sparing and with caution. We use the [Google JavaScript Style Guide](https://google.github.io/styleguide/javascriptguide.xml)
- HTML: you can do whatever you want as long as you can explain it 3 days later.

Regardless of the language you are working on, **good documentation is always encouraged**. If you think you won't understand it if you look at it a year later, put a line or two explaining what's going on.

#### Workflow and Review

When starting a new feature, branch off from `master` with a concise but descriptive name, e.g., `templates`. If the branch name contains more than 1 word, it should be delimited by hyphens (`-`), for example, `sku-model`. You are free to develop, commit, and push to new branches whenever you need to.

When you think a feature is completed, submit a Merge Request to the `master` branch on GitLab. (Usually, after pushing to the repo, GitLab will print the link for submitting a Merge Ruquest directly. You can also visit the repo on your browser to submit a new Merge Request.) A Merge Request must be approved by **at least one other person**, before it can be merged into master. When submitting the request, describe your changes in a clear manner, e.g. with a bullet list.

**Reviewers:** if you approve something, you're also responsible for it. So be cool, and don't be afraid to reject a merge request if you see something wrong.

## Getting Started

To get started, first clone the repository onto your computer

```bash
git clone git@gitlab.oit.duke.edu:hypomeals/hypomeals.git
cd hypomeals
```

#### HTTPS Certificates

The project uses the HTTPS protocol. For security reasons, the certificates and private keys are not included in the repository. **They must be obtained separately before running the project.** The certificates are distributed in a file named `certs.zip`: it contains a directory named `certs` which must be placed under the `nginx/` directory. In order words, the directory tree of the `nginx/` directory should look like:

```
nginx
├── certs
│   ├── vcm-4081.vm.duke.edu.key
│   └── vcm-4081.vm.duke.edu.pem
└── config
    └── web-app.conf
```

**Note:** the certificates are self-issued, which means most modern browsers will warn you that the certificate is not trusted. This is fine, and the warning should be dismissed.

However, the certificates are issued with an extension called `Subject Alternative Name`s, and will certify three hosts: `vcm-4081.vm.duke.edu` (the production server), `127.0.0.1` and `localhost`. What that means is that, although your browser may warn about untrusted issuer, it **should not** warn about an invalid common name, if the project is being deployed locally.

Once ther certificates are obtained, there are then two ways to run the project: using Docker directly, or setting up a virtual environment.

##### Changing the domain name

If you wish to deploy on a different server with a different domain name, you will need to provide your own certificates. 

First, place the certificates in the `nginx/certs` directory. Then, you will need to edit the file `nginx/config/web-app.conf` and point the `ssl_certificate` and `ssl_certificate_key` parameters to the correct filenames.

**Note:** the `nginx/certs` directory is automatically mapped to the correct location in the Docker container.

#### Virtual Environment (Recommended)

A virtual environment may be much better suited for development, because some IDEs can automatically detect and run the Django project, if the environment is set up correctly. To set up a new virtual environment on a Unix host, use these commands under the root directory of the project:

```bash
# This will set up a fresh environment under a directory named venv/
python -m venv venv/
# This will "activate" the new virtual environment
source venv/bin/activate
```

For tutorials and guides on setting up virtual environments on other OSes, check the [official documentation](https://docs.python.org/3/library/venv.html#module-venv).

Once the virtual environment is activated, install all project requirements:

```
pip install -r hypomeals/requirements.txt
```

Then, to start the Django development server, use the command:

```bash
cd hypomeals/
python manage.py runserver 8000
```

Finally, to see the website, go to `http://127.0.0.1:8000` on your browser. 

#### Docker

The project is designed to be deployed by a Docker engine. A `docker-compose.yml` is provided so that the containers may be spun up easily all at once. In the root directory of the project, simply type

```bash
sudo docker-compose up
```

**Note:** `sudo` may not be required on Windows or macOS computers.

Once the containers are all set up, visit `https://127.0.0.1` on your host computer. Due to restrictions on Docker containers, it is not possible to set up automatic protocol upgrade to SSL. You must therefore enter `https:` as the protocol name explicitly.
